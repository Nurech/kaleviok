steps:
  # Install dependencies
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        npm install

  # Determine the branch and fetch secrets accordingly
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "master" ]]; then
          echo "Production build triggered."
          export NODE_ENV=prod
          export FIREBASE_PROJECT_ID=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID_prod)
          export FIREBASE_APP_ID=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID_prod)
          export FIREBASE_STORAGE_BUCKET=$(gcloud secrets versions access latest --secret=FIREBASE_STORAGE_BUCKET_prod)
          export FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY_prod)
          export FIREBASE_AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN_prod)
          export FIREBASE_MESSAGING_SENDER_ID=$(gcloud secrets versions access latest --secret=FIREBASE_MESSAGING_SENDER_ID_prod)
          export FIREBASE_MEASUREMENT_ID=$(gcloud secrets versions access latest --secret=FIREBASE_MEASUREMENT_ID_prod)
          npm run env:prod
        elif [[ "$BRANCH_NAME" == "develop" ]]; then
          echo "Development build triggered."
          export NODE_ENV=dev
          export FIREBASE_PROJECT_ID=$(gcloud secrets versions access latest --secret=FIREBASE_PROJECT_ID_dev)
          export FIREBASE_APP_ID=$(gcloud secrets versions access latest --secret=FIREBASE_APP_ID_dev)
          export FIREBASE_STORAGE_BUCKET=$(gcloud secrets versions access latest --secret=FIREBASE_STORAGE_BUCKET_dev)
          export FIREBASE_API_KEY=$(gcloud secrets versions access latest --secret=FIREBASE_API_KEY_dev)
          export FIREBASE_AUTH_DOMAIN=$(gcloud secrets versions access latest --secret=FIREBASE_AUTH_DOMAIN_dev)
          export FIREBASE_MESSAGING_SENDER_ID=$(gcloud secrets versions access latest --secret=FIREBASE_MESSAGING_SENDER_ID_dev)
          export FIREBASE_MEASUREMENT_ID=$(gcloud secrets versions access latest --secret=FIREBASE_MEASUREMENT_ID_dev)
          npm run env:dev
        else
          echo "Unsupported branch: $BRANCH_NAME"
          exit 1
        fi

  # Build application
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$NODE_ENV" == "prod" ]]; then
          npm run build:prod
        else
          npm run build:dev
        fi

  # Deploy to Firebase Hosting
  - name: 'gcr.io/firebase-ci/firebase-tools'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        firebase deploy --only hosting --project=${FIREBASE_PROJECT_ID}
